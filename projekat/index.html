<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<title>Coffee shops</title>
</head>

<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4_e21TW2apQ6PRUWJooAeLq3vMKrQWgo&callback=initMap"></script>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<body>
	<div class="myContainer">
		<div class="row justify-content-center" id="row">
				<h1>Find best coffee near you!</h1>
			</div>
		<div class="row" id="search">
			<div class="col-md-7">
				<div class="row coffeeShops"> 
				</div>
			</div>
			<div class="col-md-5">
				<div id="mapcanvas"></div>
			</div>
		</div>
	</div>

<script>

function success(position) {

	var la = position.coords.latitude;
	var lo = position.coords.longitude;
	var ll= "&ll="+la+"%2C%20"+lo;
	var url = "https://api.foursquare.com/v2/venues/search?v=20171110&limit=10&intent=browse&radius=1000&categoryId=4bf58dd8d48988d16d941735&client_id=V3BJFODOXVUJ1G2NETOG4FMDJB4AUTPAMYOFW03UQXWINFV2&client_secret=4HEL0NQNH2I1NFK4X3LB5M3FWTM5NSI5WNOEEBRIMHOSIICS&sort=nearby"+ll;

	var mapcanvas = document.getElementById("mapcanvas");
	var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
	var myOptions = {
		zoom: 15,
		center: latlng,
		mapTypeControl: false,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);

	
	var marker = new google.maps.Marker({
		position: latlng,
		map: map,
		title:"Vi ste ovde!"
	});

	$.getJSON( url, function( data ) {

			for(var i=0; i< data.response.venues.length; i++)
			{
				
				$(".coffeeShops").append('<div class="card w-100 myCard"> <div class="card-body"> <img class="icon" src="cof.png"> <h4 class="card-title">'
					+data.response.venues[i].name+'</h4> <p class="card-text">'+data.response.venues[i].location.address+'  | Udaljenost:  <span id="distance">'
					+data.response.venues[i].location.distance+'</span>m</p> <button type="button" onclick="showDetails(\''+data.response.venues[i].id+'\')" class="btn btn-primary" id="panel_button" data-toggle="modal" data-target="#exampleModal"> Vise informacija </button></div> </div>');

				var latlng1 = new google.maps.LatLng(data.response.venues[i].location.lat, data.response.venues[i].location.lng);
				var m1 = new google.maps.Marker({
					position: latlng1,
					map: map,
					title: data.response.venues[i].name,
					icon: "marker.png"
				});
			}
	});
}
function error(msg) {
		innerHTML = "You need to enable allow location access to find coffee places";
		s.className = 'fail';
}

function showDetails(id)
{
	var url1 = "https://api.foursquare.com/v2/venues/"+id+"?client_id=V3BJFODOXVUJ1G2NETOG4FMDJB4AUTPAMYOFW03UQXWINFV2&client_secret=4HEL0NQNH2I1NFK4X3LB5M3FWTM5NSI5WNOEEBRIMHOSIICS&v=20171111";
	$.getJSON( url1, function( data ) {
		console.log(data);
		$("#coffeeTitle")[0].innerHTML = data.response.venue.name;
		$(".coffeeAddress")[0].innerHTML = data.response.venue.location.address;
		$(".coffeePrice")[0].innerHTML = "Prices: "+data.response.venue.price.message;
		if(data.response.venue.url)
			$(".coffeeWebsite")[0].innerHTML = "Website: <a href='"+data.response.venue.url+"'>"+data.response.venue.url+"</a>";
		else $(".coffeeWebsite")[0].innerHTML = "";
		if(data.response.venue.contact.formattedPhone)
			$(".coffeePhone")[0].innerHTML = "Phone: "+data.response.venue.contact.formattedPhone;
		else $(".coffeePhone")[0].innerHTML = "";
		if(data.response.venue.popular){
			if(data.response.venue.popular.isOpen = true) {
				$(".coffeeTime")[0].innerHTML = "<span id='wt'>Working now</span> | Working time today: "+data.response.venue.popular.timeframes[0].open[0].renderedTime;
			} else {
				$(".coffeeTime")[0].innerHTML = "<span id='nwt'>Not working now</span> | Working time today: "+data.response.venue.popular.timeframes[0].open[0].renderedTime;
			}
		}
		else $(".coffeeTime")[0].innerHTML = "";
		if(data.response.venue.tips.count>0){
			$(".coffeeTips")[0].innerHTML = "Tips: <br>";
			for(i=0; i<=data.response.venue.tips.count; i++){
				if(data.response.venue.tips.groups[0].items[i].text.indexOf("coffee") !== -1) {
				$(".coffeeTips").append(data.response.venue.tips.groups[0].items[i].user.firstName+" : "+data.response.venue.tips.groups[0].items[i].text+"<br>");
				}
			}
		}
		else $(".coffeeTips")[0].innerHTML = "";
	});
}

if (navigator.geolocation) {
	navigator.geolocation.getCurrentPosition(success, error);
	
} else {
  error('not supported');
}

var $divs = $('.myCard');

$('#disOrdered').on('click', function(){
	var distanceOrderedDivs = $divs.sort(function(a,b){
		return $(a).find("#distance").text() > $(b).find("#distance").text();
	});
	$(".coffeeShops").append(distanceOrderedDivs);
});

</script>

	<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
			  		<h5 class="modal-title" id="coffeeTitle">TT</h5>
			  		<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
			  		</button>
				</div>
				<div id="coffeeDetails" class="modal-body">
					<div class="row">
						<div class="col-md-6 coffeeAddress"></div>
						<div class="col-md-6 coffeePrice"></div>
						<div class="col-md-6 coffeeWebsite"></div>
						<div class="col-md-6 coffeePhone"></div>
						<div class="col-md-12 coffeeTime"></div>
						<div class="col-md-12 coffeeTips"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>